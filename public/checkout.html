<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout - THE RAS</title>
  <link rel="stylesheet" href="./css/style.css">
</head>
<body>
  <header class="header">
    <div class="container header-content">
      <a href="/" class="logo">THE RAS</a>
      
      <div class="header-actions">
        <a href="/cart" class="cart-icon">
          ðŸ›’
          <span class="cart-count">0</span>
        </a>
        <a href="/" class="btn btn-secondary">Continue Shopping</a>
      </div>
    </div>
  </header>

  <section class="section">
    <div class="container">
      <h1>Checkout</h1>
      
      <div class="checkout-container">
        <div class="checkout-main">
          <div class="checkout-section">
            <h2>Shipping Information</h2>
            <form id="checkoutForm" class="checkout-form">
              <div class="form-row">
                <div class="form-group">
                  <label for="firstName">First Name</label>
                  <input type="text" id="firstName" name="firstName" required>
                </div>
                
                <div class="form-group">
                  <label for="lastName">Last Name</label>
                  <input type="text" id="lastName" name="lastName" required>
                </div>
              </div>
              
              <div class="form-group">
                <label for="email">Email Address</label>
                <input type="email" id="email" name="email" required>
              </div>
              
              <div class="form-group">
                <label for="phone">Phone Number</label>
                <input type="tel" id="phone" name="phone" required>
              </div>
              
              <div class="form-group">
                <label for="address">Street Address</label>
                <input type="text" id="address" name="address" required>
              </div>
              
              <div class="form-row">
                <div class="form-group">
                  <label for="city">City</label>
                  <input type="text" id="city" name="city" required>
                </div>
                
                <div class="form-group">
                  <label for="state">State</label>
                  <input type="text" id="state" name="state" required>
                </div>
                
                <div class="form-group">
                  <label for="zipCode">ZIP Code</label>
                  <input type="text" id="zipCode" name="zipCode" required>
                </div>
              </div>
              
              <div class="form-group">
                <label for="country">Country</label>
                <input type="text" id="country" name="country" value="United States" required>
              </div>
            </form>
          </div>
          
          <div class="checkout-section">
            <h2>Payment Information</h2>
            <div class="payment-demo">
              <p><strong>Demo Mode:</strong> This is a demonstration checkout. No actual payment will be processed.</p>
              <div class="demo-card">
                <p>ðŸ’³ Demo Credit Card</p>
                <p>Card Number: â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ 4242</p>
                <p>Expires: 12/25</p>
              </div>
            </div>
          </div>
        </div>
        
        <aside class="checkout-sidebar">
          <div class="order-summary">
            <h2>Order Summary</h2>
            
            <div id="orderItems" class="order-items">
            </div>
            
            <div class="order-totals">
              <div class="total-row">
                <span>Subtotal:</span>
                <span id="subtotal">$0.00</span>
              </div>
              <div class="total-row">
                <span>Shipping:</span>
                <span id="shipping">$10.00</span>
              </div>
              <div class="total-row">
                <span>Tax (8%):</span>
                <span id="tax">$0.00</span>
              </div>
              <div class="total-row grand-total">
                <span>Total:</span>
                <span id="grandTotal">$0.00</span>
              </div>
            </div>
            
            <button class="btn btn-primary btn-full" onclick="handlePlaceOrder()">Place Order</button>
          </div>
        </aside>
      </div>
    </div>
  </section>

  <script src="/js/api.js"></script>
  <script src="/js/cart.js"></script>
  <script>
    const SHIPPING_COST = 10.00;
    const TAX_RATE = 0.08;

    function loadOrderSummary() {
      const cart = getCart();
      const orderItems = document.getElementById('orderItems');
      
      if (cart.length === 0) {
        orderItems.innerHTML = '<p class="empty-cart">Your cart is empty</p>';
        document.getElementById('subtotal').textContent = '$0.00';
        document.getElementById('tax').textContent = '$0.00';
        document.getElementById('grandTotal').textContent = '$10.00';
        return;
      }
      
      orderItems.innerHTML = cart.map(item => `
        <div class="order-item">
          <img src="${item.image}" alt="${item.title}">
          <div class="order-item-details">
            <div class="order-item-title">${item.title}</div>
            <div class="order-item-quantity">Qty: ${item.quantity}</div>
          </div>
          <div class="order-item-price">$${(item.price * item.quantity).toFixed(2)}</div>
        </div>
      `).join('');
      
      const subtotal = getCartTotal();
      const tax = subtotal * TAX_RATE;
      const total = subtotal + SHIPPING_COST + tax;
      
      document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
      document.getElementById('shipping').textContent = `$${SHIPPING_COST.toFixed(2)}`;
      document.getElementById('tax').textContent = `$${tax.toFixed(2)}`;
      document.getElementById('grandTotal').textContent = `$${total.toFixed(2)}`;
    }

    async function handlePlaceOrder() {
      const form = document.getElementById('checkoutForm');
      
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }
      
      const cart = getCart();
      if (cart.length === 0) {
        alert('Your cart is empty. Please add items before checking out.');
        return;
      }
      
      const orderData = {
        firstName: document.getElementById('firstName').value,
        lastName: document.getElementById('lastName').value,
        email: document.getElementById('email').value,
        phone: document.getElementById('phone').value,
        address: document.getElementById('address').value,
        city: document.getElementById('city').value,
        state: document.getElementById('state').value,
        zipCode: document.getElementById('zipCode').value,
        country: document.getElementById('country').value,
        items: cart,
        subtotal: getCartTotal(),
        shipping: SHIPPING_COST,
        tax: getCartTotal() * TAX_RATE,
        total: getCartTotal() + SHIPPING_COST + (getCartTotal() * TAX_RATE)
      };
      
      const res = await placeOrder(orderData);
      
  
      
      if (res.success) {
        clearCart();
        alert("Order placed successfully!");
        localStorage.removeItem("cart");
        window.location.href = "/ordersuccess";
      } else {
        const loggedIn = await isLoggedIn();

        if (!loggedIn) {
          if (confirm('You need to login to place an order. Go to login page?')) {
            window.location.href = '/login?redirect=checkout';
          }
          return;
        }
        alert("Something went wrong");;
      }
    }
      

    const user = getCurrentUser();
    if (user) {
      document.getElementById('email').value = user.email;
    }

    loadOrderSummary();
  </script>
</body>
</html>
